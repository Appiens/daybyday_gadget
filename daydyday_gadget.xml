<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="daybyday_gadget" scrolling="true" author_email="info@appiens.com" height="500">
    <Require feature="opensocial-0.8" />
    <Require feature="locked-domain"/>
      <OAuth>
      <Service name="google">
        <Access url="https://www.google.com/accounts/OAuthGetAccessToken" method="GET" /> 
            <Request url="https://www.google.com/accounts/OAuthGetRequestToken?scope=https://www.googleapis.com/auth/tasks" method="GET" /> 
        <Authorization url="https://www.google.com/accounts/OAuthAuthorizeToken?oauth_callback=http://oauth.gmodules.com/gadgets/oauthcallback" /> 
      </Service>
    </OAuth>
    <Locale messages="https://raw.githubusercontent.com/Appiens/daybyday_gadget/master/lang/ALL_ALL.xml"/>
    <Locale lang="ru" messages="https://raw.githubusercontent.com/Appiens/daybyday_gadget/master/lang/ru_ALL.xml"/>
  </ModulePrefs>
  <Content type="html">
  <![CDATA[ 
  

  <style>
  	#main {
	  margin: 0px;
	  padding: 0px;
      font-size: small;
	}

	#watch {
	  margin: 0px;
	  padding: 0px;
      font-size: small;
	}
	
	#listId {
  	  margin: 0;
  	  padding: 0;
	}

	.collapsibleList li{
    	  list-style-image:none; 
    	  list-style-type:none;
          cursor:auto;
          list-style: none;
  	      padding: 0;
  	      margin: 0;
	}

    li.collapsibleListOpen{
         cursor:pointer;
         background: url('https://raw.githubusercontent.com/Appiens/daybyday_gadget/master/images/button-minus.png'); <!--no-repeat top left;-->
         background-position: 0 5px;
         background-size: 12px 12px;
         background-repeat: no-repeat;
  	     margin: 0;
  	     list-style: none;
  	     padding: 0 0 0 15px;
    }

    li.collapsibleListClosed{
         cursor:pointer;
         background: url('https://raw.githubusercontent.com/Appiens/daybyday_gadget/master/images/button-plus.png'); <!--no-repeat top left;-->
         background-position: 0 5px;
         background-size: 12px 12px;
         background-repeat: no-repeat;
  	     margin: 0;
  	     list-style: none;
  	     padding: 0 0 0 15px;
    }
       
	ul {
    padding: 0; /* Убираем поля */
    	margin-left: 5px; /* Отступ слева */
	}

	.myStyle span {
    	text-indent:25px;
        display:inline-block;
    	cursor:pointer;
	}

    .new-select-style-wpandyou select, textarea, input[type=text], input[type=date] {
        font-family: Arial;
        width:87%;
        min-height:20px;
        display:block;
        margin-bottom:8px;
        margin-top:5px;
        padding-left:5px;
        outline: none;
        box-sizing:content-box;
    }

    .new-select-style-wpandyou  input[type=date] {
        font-family: Arial;
        margin-bottom:8px;
        margin-top:5px;
        padding-left:5px;
        padding-right: 0px;
        outline: none;
        outline-width: thin;
        box-sizing:content-box;
        display:block;
    }

    input[type=button] {
        background-color: #DFEEFF;
        text-indent:0px;
        border:1px solid #0099CC;
        display:inline-block;
        color:#14396a;
        font-weight:normal;
        font-style:normal;
        font-size: medium;
        height:20px;
        line-height:20px;
        text-decoration:none;
        text-align:center;
        vertical-align:top;
        margin-bottom:0px;
        margin-top:0px;
    }

    input[type=button]:hover {
        background-color:#33B5E5;
    }

    input[type=button]:active {
        position:relative;
        top:1px;
    }

    textarea {
        resize: vertical;
    }
  </style>
  <script type="text/javascript" src="https://rawgit.com/Appiens/daybyday_gadget/master/javascript/CollapsibleLists.js"></script>
  <script type="text/javascript" src="https://rawgit.com/Appiens/daybyday_gadget/master/javascript/shindig.js"></script>
  <script type="text/javascript" src="https://rawgit.com/Appiens/daybyday_gadget/master/javascript/WinFuncs.js"></script>
  <script type="text/javascript" src="https://rawgit.com/Appiens/daybyday_gadget/master/javascript/DateTimeClass.js"></script>
  <script type="text/javascript">
  
    var taskLists = [];
    var errorOccured = false;

    // Invoke makeRequest() to fetch data from the service provider endpoint.
    // Depending on the results of makeRequest, decide which version of the UI
    // to ask showOneSection() to display. If user has approved access to his
    // or her data, display data.
    // If the user hasn't approved access yet, response.oauthApprovalUrl contains a
    // URL that includes a Google-supplied request token. This is presented in the 
    // gadget as a link that the user clicks to begin the approval process. 
       
    function fetchData() {
      errorOccured = false;
      var params = {};
      url = "https://www.googleapis.com/tasks/v1/users/@me/lists?key=" + API_KEY;
      params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
      params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.OAUTH;
      params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "google";
      params[gadgets.io.RequestParameters.OAUTH_USE_TOKEN] = "always";
      params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;

      gadgets.io.makeRequest(url, function (response) { 
        if (response.oauthApprovalUrl) {
          // Create the popup handler. The onOpen function is called when the user
          // opens the popup window. The onClose function is called when the popup
          // window is closed.
          var popup = shindig.oauth.popup({
            destination: response.oauthApprovalUrl,
            windowOptions: null,
            onOpen: function() { showOneSection('waiting'); },
            onClose: function() { fetchData(); }
          });
          // Use the popup handler to attach onclick handlers to UI elements.  The
          // createOpenerOnClick() function returns an onclick handler to open the
          // popup window.  The createApprovedOnClick function returns an onclick 
          // handler that will close the popup window and attempt to fetch the user's
          // data again.
          var personalize = document.getElementById('personalize');
          personalize.onclick = popup.createOpenerOnClick();
          var approvaldone = document.getElementById('approvaldone');
          approvaldone.onclick = popup.createApprovedOnClick();
          showOneSection('approval');
        } else if (response.data) {
            alert('13:44');
            init(makePOSTRequest);
            taskLists = [];
            taskLists = response.data.items;
            for(var i=0; i< taskLists.length; i++) {
               taskLists[i].isLoading = true;
               getTasksForTaskList(taskLists[i]);
            }
        } else {
            // The response.oauthError and response.oauthErrorText values may help debug
            // problems with your gadget.
            var main = document.getElementById('main');
            var err = document.createTextNode('OAuth error: ' +
              response.oauthError + ': ' + response.oauthErrorText);
            main.appendChild(err);
            showOneSection('main');
            errorOccured = true;
        }
      }, params);
    }
    
    function getTasksForTaskList(taskList) {
        if (errorOccured) {
           return;
        }
    
        var params = {};
	    url = "https://www.googleapis.com/tasks/v1/lists/" + taskList.id + "/tasks?key=" + API_KEY + "&showCompleted=true";
        params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
        params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.OAUTH;
        params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "google";
        params[gadgets.io.RequestParameters.OAUTH_USE_TOKEN] = "always";
        params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
 
        gadgets.io.makeRequest(url, function (response) { 
        if (response.oauthApprovalUrl) {
          // сюда попадать вообще не должны
        } else if (response.data) {
           taskList.isLoading = false;
           taskList.tasks = response.data.items;
           
           if (allTasksLoaded()) {
              generateList(taskLists);
              CollapsibleLists.applyTo(document.getElementById('listId'));
              showOneSection('main');
              alert('done');
           }
            
        } else {
            // The response.oauthError and response.oauthErrorText values may help debug
            // problems with your gadget.
            var main = document.getElementById('main');
            var err = document.createTextNode('OAuth error: ' +
              response.oauthError + ': ' + response.oauthErrorText);
            main.appendChild(err);
            showOneSection('main');
            errorOccured = true;
        }
      }, params);
   
    }
    
    function allTasksLoaded() {
        var i;
        for(var i=0; i< taskLists.length; i++) {
            if (taskLists[i].isLoading) {
                break;
            }
        }

        return i == taskLists.length;
    }
    
   function makePOSTRequest(url, postdata, callback) {
   	var params = {};
   	params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
   	params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.PUT;
   	params[gadgets.io.RequestParameters.HEADERS] = {'Content-Type': 'application/json'}
    params[gadgets.io.RequestParameters.POST_DATA]= postdata;
   	params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.OAUTH;
   	params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "google";
   	params[gadgets.io.RequestParameters.OAUTH_USE_TOKEN] = "always";
   	gadgets.io.makeRequest(url, callback, params);
};

    // Call fetchData() when gadget loads.
    gadgets.util.registerOnLoadHandler(fetchData);
  </script>
  
  <div id="main" style="display: none; height: 450; overflow-y: scroll;">
	<ul id="listId" class="collapsibleList"></ul>
  </div>

  <div id="approval" style="display: none">
    <a href="#" id="personalize">Personalize this gadget</a>
  </div>

  <div id="waiting" style="display: none">
    Please click
    <a href="#" id="approvaldone">I've approved access</a>
    once you've approved access to your data.
  </div>

  <div id="watch" style="display: none">
     <table cellpadding=0 width=87%>
                <tr>
                    <td style="width: 7%; text-align:left; vertical-align:middle;">
                         <input type="checkbox" id="checkbox-task-completed" name="checkbox-task-completed" checked="false" title="">
                    </td>
                    <td style="width: 93%; text-align:left; vertical-align:middle;font-size: small;">
                        <label id="label-task-completed">__MSG_completed__</label>
                    </td>
                </tr>
    </table>
    <input type="text" id="input-task-name" name="input-task-name" placeholder="__MSG_title_default__"/>
    <table cellpadding=0 width=87%>
                <tr>
                    <td style="width: 7%; text-align:left; vertical-align:middle;">
                            <input type="checkbox" id="checkbox-with-date" name="checkbox-with-date" checked="true" title="">
                    </td>
                    <td style="width: 93%; text-align:left; vertical-align:middle;font-size: small;">
                        <label id="label-task-date">__MSG_due_date__</label>
                    </td>
                </tr>
    </table>
    <input type="date" id="input-task-date" name="input-task-date" required>
    <div id="div-notes" class="new-select-style-wpandyou">
    <textarea name="input-task-comment" id="input-task-comment" rows="5" placeholder="__MSG_notes_default__"></textarea>
    </div>
       <table cellpadding=0 width=50%>
                <tr>
                    <td style="width: 25%; text-align:left; vertical-align:middle;">
                        <input type="button" id="button-back-to-list" name="button-back-to-list" value="&#x25C1" title="__MSG_action_back_to_list__"/>
                    </td>
                    <td style="width: 25%; text-align:left; vertical-align:middle;">
                        <input type="button" id="button-save_task" name="button-save-task" value="&#x2713" title="__MSG_action_save_task__"/>
                    </td>
                    <td style="width: 25%; text-align:left; vertical-align:middle;">
                        <input type="button" id="button-to-subtasks" name="button-to-subtasks" value="&#x2261" title="__MSG_action_to_subtasks__"/>
                    </td>
                    <td style="width: 25%; text-align:left; vertical-align:middle;">
                        <input type="button" id="button-discard" name="button-discard" value="&#x2715" title="__MSG_action_discard__"/>
                    </td>
                </tr>
    </table>

    <a href="#" id="href-back">&#x25C1 __MSG_action_back_to_list__</a>
  </div>
  ]]> 
  </Content>
</Module>
